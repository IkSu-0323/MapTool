<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é­”éˆæ¨™ç¤ºè¼”åŠ©å™¨</title>

<style>
  :root { color-scheme: dark; }
  body{
    margin:0;
    background:#111;
    color:#fff;
    font-family: system-ui, -apple-system, "Segoe UI", "Noto Sans TC", sans-serif;
  }

  header{
    position: sticky;
    top:0;
    background: rgba(17,17,17,.92);
    backdrop-filter: blur(8px);
    border-bottom: 1px solid rgba(255,255,255,.08);
    padding: 12px 14px;
    z-index:10;
  }

  h1{
    margin:0 0 10px 0;
    font-size:18px;
    font-weight:650;
  }

  .row{
    display:flex;
    flex-wrap:wrap;
    gap:8px;
    align-items:center;
  }

  select, input[type="text"], button{
    background:#1b1b1b;
    color:#fff;
    border:1px solid rgba(255,255,255,.14);
    border-radius:10px;
    padding:8px 10px;
    font-size:14px;
    outline:none;
  }
  input[type="text"]{ width:220px; }
  button{ cursor:pointer; }

  button.primary{ border-color: rgba(130,200,255,.6); }
  button.danger { border-color: rgba(255,120,120,.6); }

  button.active{
    border-color: rgba(120,255,180,.7);
    box-shadow: 0 0 0 2px rgba(120,255,180,.15) inset;
  }

  .hint{
    margin-top:10px;
    font-size:12px;
    color: rgba(255,255,255,.72);
    line-height:1.45;
  }
  .hint-strong{ color:#fbbf24; font-weight:650; }
  .hint-info  { color:#7dd3fc; }
  .hint-title { color:#a7f3d0; font-weight:650; }
  .hint-warning{ color:#fb7185; font-weight:650; }

  .hint-line{ margin:4px 0; }
  .hint-details{
    margin-top:10px;
    padding-top:8px;
    border-top:1px solid rgba(255,255,255,.10);
  }
  .hint-details summary{
    cursor:pointer;
    color: rgba(255,255,255,.85);
    font-weight:650;
    list-style:none;
    user-select:none;
  }
  .hint-details summary::-webkit-details-marker{ display:none; }
  .hint-block{ margin-top:10px; }
  .hint-subtitle{ font-weight:650; color: rgba(255,255,255,.90); margin-bottom:4px; }
  .hint-text{ color: rgba(255,255,255,.75); }
  .hint-list{ margin:6px 0 0 18px; padding:0; }
  .hint-list li{ margin:4px 0; }

  main{ padding:14px; }

  #mapWrap{
    display:flex;
    gap:12px;
    align-items:flex-start;
    justify-content:center;
  }

  #legend{
    width:260px;
    max-width:45vw;
    background: rgba(255,255,255,.04);
    border:1px solid rgba(255,255,255,.10);
    border-radius:14px;
    padding:10px;
    position: sticky;
    top:92px;
  }

  .legend-title{
    font-size:13px;
    font-weight:700;
    margin:2px 0 10px 0;
    color: rgba(255,255,255,.90);
  }

  .legend-item{
    display:flex;
    align-items:center;
    gap:10px;
    padding:8px 8px;
    border-radius:12px;
  }
  .legend-item:hover{ background: rgba(255,255,255,.05); }

  .legend-icon{
    width:22px;
    height:22px;
    border-radius:6px;
    flex:0 0 auto;
  }

  .legend-text{ font-size:13px; color: rgba(255,255,255,.82); line-height:1.2; }
  .legend-state{ font-size:12px; color: rgba(255,255,255,.55); margin-left:auto; }

  .panel-sep{ margin:10px 0; border-top:1px solid rgba(255,255,255,.10); }

  .stats-title{
    font-size:13px;
    font-weight:700;
    margin:10px 0 8px 0;
    color: rgba(255,255,255,.90);
  }

  .stats-row{
    display:flex;
    align-items:center;
    gap:8px;
    padding:7px 8px;
    border-radius:12px;
  }
  .stats-row:hover{ background: rgba(255,255,255,.05); }

  .stats-name{
    font-size:13px;
    color: rgba(255,255,255,.86);
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    flex:1 1 auto;
  }

  .stats-counts{
    display:flex;
    gap:10px;
    flex:0 0 auto;
    font-size:12px;
    color: rgba(255,255,255,.68);
  }

  .pill{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:3px 8px;
    border-radius:999px;
    border:1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.12);
  }
  .pill img{ width:14px; height:14px; border-radius:4px; }

  .fail-title{
    font-size:13px;
    font-weight:700;
    margin:10px 0 8px 0;
    color: rgba(255,255,255,.90);
  }
  .fail-item{
    font-size:12px;
    color: rgba(255,255,255,.72);
    padding:6px 8px;
    border-radius:12px;
    border:1px dashed rgba(255,120,120,.35);
    background: rgba(255,120,120,.06);
    margin:6px 0;
    line-height:1.35;
  }
  .fail-empty{ font-size:12px; color: rgba(255,255,255,.55); padding:6px 8px; }

  #mapContainer{
    position:relative;
    display:inline-block;
    margin:8px auto 18px auto;
    border-radius:14px;
    overflow:hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,.35);
    border:1px solid rgba(255,255,255,.08);
    max-width: min(1200px, 96vw);
    max-height: calc(100vh - 240px);
  }

  #mapImg{
    display:block;
    width:100%;
    height:auto;
    max-height: calc(100vh - 240px);
    object-fit: contain;
  }

  .marker{
    position:absolute;
    width:30px;
    height:30px;
    transform: translate(-50%, -50%);
    cursor:pointer;
    user-select:none;
  }
  .marker:hover{ filter: drop-shadow(0 0 6px rgba(255,255,255,.25)); }

  .badge{
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding:6px 10px;
    border:1px dashed rgba(255,255,255,.18);
    border-radius:999px;
    font-size:12px;
    color: rgba(255,255,255,.8);
  }
  .badge b{ color: rgba(255,255,255,.95); }

  @media (max-width: 920px){
    header{ padding:10px 10px; }
    h1{ font-size:16px; }
    .row{ gap:8px; }
    select, input[type="text"], button{
      font-size:15px;
      padding:10px 12px;
      border-radius:12px;
    }
    input[type="text"]{ width: min(260px, 70vw); }

    #mapWrap{ flex-direction: column; align-items: stretch; }
    #legend{ width:auto; max-width:none; position:relative; top:0; margin-bottom:10px; }

    .hint{ font-size:13px; line-height:1.55; }
    .marker{ width:34px; height:34px; }
  }

  /* ===== ä¸‹æ‹‰é¸å–®ï¼ˆåªé»æ“Šæ‰å±•é–‹ / å†é»ä¸€æ¬¡æ”¶èµ·ï¼‰ ===== */
  .menu-group{ display:flex; gap:8px; flex-wrap:wrap; }
  .dropdown{ position:relative; }

  .menu-btn{
    background:#1b1b1b;
    color:#fff;
    border:1px solid rgba(255,255,255,.14);
    border-radius:10px;
    padding:8px 12px;
    cursor:pointer;
  }

  .menu{
    position:absolute;
    top:calc(100% + 6px);
    left:0;
    min-width:220px;
    background:#181818;
    border:1px solid rgba(255,255,255,.12);
    border-radius:12px;
    box-shadow:0 12px 30px rgba(0,0,0,.4);
    padding:6px;
    display:none;
    z-index:50;
  }
  .dropdown.open .menu{ display:block; }

  .menu button{
    width:100%;
    text-align:left;
    background:transparent;
    border:none;
    color:#fff;
    padding:8px 10px;
    border-radius:8px;
    cursor:pointer;
  }
  .menu button:hover{ background: rgba(255,255,255,.08); }
  .menu .danger{ color:#ff7b7b; }
  .menu hr{
    border:none;
    border-top:1px solid rgba(255,255,255,.1);
    margin:6px 0;
  }

  @media (max-width: 920px){
    .menu{ min-width: min(92vw, 320px); }
  }

  /* ===== åœ°åœ–æ’åº Modal ===== */
  #sortModal{
    position:fixed;
    inset:0;
    background: rgba(0,0,0,.62);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:220;
  }
  #sortModal[hidden]{ display:none; }

  .sort-panel{
    width:min(92vw, 420px);
    background:#181818;
    border:1px solid rgba(255,255,255,.12);
    border-radius:14px;
    box-shadow:0 18px 50px rgba(0,0,0,.55);
    padding:14px;
  }

  .sort-head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    margin-bottom:10px;
  }
  .sort-title{
    font-weight:750;
    font-size:14px;
    color: rgba(255,255,255,.92);
  }
  .sort-sub{
    font-size:12px;
    color: rgba(255,255,255,.62);
    margin-top:2px;
    line-height:1.35;
  }

  .sort-actions{ display:flex; gap:8px; }
  .sort-actions button{
    border:1px solid rgba(255,255,255,.14);
    border-radius:10px;
    padding:8px 10px;
    background:#1b1b1b;
    color:#fff;
    cursor:pointer;
  }

  #sortList{
    list-style:none;
    padding:0;
    margin:10px 0 0 0;
    max-height: min(56vh, 420px);
    overflow:auto;
  }

  #sortList li{
    display:flex;
    align-items:center;
    gap:10px;
    padding:10px 10px;
    border:1px solid rgba(255,255,255,.14);
    border-radius:12px;
    background:#1f1f1f;
    margin-bottom:8px;
    cursor:grab;
    user-select:none;
  }

  #sortList li:active{ cursor:grabbing; }
  #sortList li.dragging{ opacity:.45; }

  .drag-handle{
    width:18px; height:18px;
    border-radius:6px;
    border:1px solid rgba(255,255,255,.12);
    display:inline-flex;
    align-items:center;
    justify-content:center;
    color: rgba(255,255,255,.65);
    font-size:12px;
    flex:0 0 auto;
  }

  .sort-name{
    flex:1 1 auto;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    color: rgba(255,255,255,.9);
    font-size:13px;
  }
  /* ===== é­”éˆåˆ·æ–°è¦å‰‡ Dialog ===== */
.rule-btn{
  margin-top:10px;
  background: transparent;
  border: 1px solid rgba(255,255,255,.16);
  color: rgba(255,255,255,.92);
  padding: 10px 12px;
  border-radius: 12px;
  cursor: pointer;
}
.rule-btn:hover{ background: rgba(255,255,255,.06); }

.rule-dialog{
  width: min(760px, 92vw);
  border: 1px solid rgba(255,255,255,.14);
  border-radius: 16px;
  padding: 0;
  background: #181818;
  color: #fff;
  box-shadow: 0 18px 60px rgba(0,0,0,.55);
}
.rule-dialog::backdrop{
  background: rgba(0,0,0,.55);
}

.rule-head{
  display:flex;
  align-items:center;
  justify-content: space-between;
  padding: 12px;
  border-bottom: 1px solid rgba(255,255,255,.10);
}
.rule-title{ font-weight: 750; }
.rule-close{
  background: transparent;
  border: 1px solid rgba(255,255,255,.14);
  border-radius: 10px;
  padding: 6px 10px;
  cursor: pointer;
}

.rule-body{
  padding: 12px;
  max-height: min(72vh, 640px);
  overflow: auto;
  display: grid;
  gap: 10px;
}
.rule-card{
  border: 1px solid rgba(255,255,255,.10);
  background: rgba(255,255,255,.04);
  border-radius: 14px;
  padding: 12px;
}
.rule-card h3{
  margin: 0 0 6px 0;
  font-size: 14px;
}
.rule-card p, .rule-card li{
  margin: 6px 0;
  color: rgba(255,255,255,.78);
}

</style>
</head>

<body>
<header>
  <h1>ğŸ“ é­”éˆæ¨™ç¤ºè¼”åŠ©å™¨</h1>

  <div class="row">
    <span class="badge">æ¨¡å¼ï¼š<b id="modeLabel">ä¸€èˆ¬</b></span>

    <label>åœ°åœ–ï¼š
      <select id="mapSelect"></select>
    </label>

    <label>åç¨±ï¼š
      <input id="mapName" type="text" placeholder="åœ°åœ–åç¨±" />
    </label>

    <div class="menu-group">
      <!-- é»ä½ -->
      <div class="dropdown" data-dd>
        <button class="menu-btn" type="button" aria-expanded="false">ğŸ“ é»ä½ â–¾</button>
        <div class="menu" role="menu">
          <button id="btnAddMarker" type="button">â• æ–°å¢é»ä½</button>
          <button id="btnDeleteMarker" type="button">ğŸ—‘ï¸ åˆªé™¤é»ä½</button>
          <hr>
          <button id="btnResetAll" type="button">ğŸ”„ å…¨éƒ¨é»ä½é‡ç½®</button>
          <button id="btnDeleteMarkersCurrent" type="button">ğŸ§¹ æ¸…ç©ºæœ¬åœ°åœ–é»ä½</button>
          <button class="danger" id="btnDeleteAllMarkers" type="button">ğŸ’¥ åˆªé™¤æ‰€æœ‰é»ä½</button>
        </div>
      </div>

      <!-- åœ°åœ– -->
      <div class="dropdown" data-dd>
        <button class="menu-btn" type="button" aria-expanded="false">ğŸ—ºï¸ åœ°åœ– â–¾</button>
        <div class="menu" role="menu">
          <button id="btnAddMap" type="button">ğŸ–¼ï¸ æ–°å¢åœ°åœ–</button>
          <button class="danger" id="btnDeleteMap" type="button">ğŸ§¨ åˆªé™¤åœ°åœ–</button>
          <button id="btnReplaceMapImage" type="button">ğŸ” é‡æ–°ä¸Šå‚³æ­¤åœ°åœ–åœ–ç‰‡</button>
          <hr>
          <button id="btnSortMaps" type="button">ğŸ”– èª¿æ•´åœ°åœ–é †åº</button>
        </div>
      </div>

      <!-- è³‡æ–™ -->
      <div class="dropdown" data-dd>
        <button class="menu-btn" type="button" aria-expanded="false">ğŸ’¾ è³‡æ–™ â–¾</button>
        <div class="menu" role="menu">
          <button id="btnExport" type="button">â¬‡ï¸ åŒ¯å‡ºè³‡æ–™</button>
          <button id="btnImport" type="button">â¬†ï¸ å°å…¥è³‡æ–™</button>
          <hr>
          <button class="danger" id="btnClearAll" type="button">ğŸ§¹ æ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼ˆåˆå§‹åŒ–ï¼‰</button>
        </div>
      </div>
    </div>
  </div>

  <div class="hint">
    <div class="hint-line">
      <span class="hint-strong">æ–°å¢é­”éˆé»ä½å‰ï¼Œå»ºè­°å…ˆåƒè€ƒæ”»ç•¥ã€‚</span>
      <span class="hint-info">ï¼ˆæœ¬å·¥å…·è‡ªå‹•ä¿å­˜ï¼‰</span>
    </div>

    <div class="hint-line">
      <span class="hint-title">åˆ·æ–°æ•¸é‡</span>ï¼š
      æ·¨ç•Œå³¶ 8ï½œå†°æ¹– ä¸»åŸ 4 / éƒŠå¤– 9 / æ´çªŸ&Boss 3ï½œä¸‹æ°´é“ 7ï½œå»¢ç¤¦ 7ï½œé¾èè¦å¡ 7
    </div>

    <div class="hint-line hint-warning">
      é”æ•æ‰ä¸Šé™å¾Œï¼ŒåŒåœ°åœ–å…¶é¤˜é»ä½å¯ç•¥éã€‚
    </div>

     <button id="btnOpenRules" type="button" class="rule-btn">
     ğŸ“˜ é­”éˆåˆ·æ–°è¦å‰‡ï¼ˆé»é–‹æŸ¥çœ‹ï¼‰
     </button>
	 
  </div>
  <dialog id="ruleDialog" class="rule-dialog">
  <div class="rule-head">
    <div class="rule-title">ğŸ“˜ é­”éˆåˆ·æ–°è¦å‰‡</div>
    <button type="button" class="rule-close" id="btnCloseRules">âœ•</button>
  </div>

  <div class="rule-body">
    <section class="rule-card">
      <h3>åˆ·æ–°é †åº</h3>
      <p>3 â†’ 6 â†’ 2 â†’ 5 â†’ 1 â†’ 4 â†’ 7ï¼ˆå¾ªç’°ï¼‰</p>
      <p>â€» ç¦®æ‹œä¸‰ã€å…­ã€äºŒã€äº”ã€ä¸€ã€å››ã€æ—¥</p>
    </section>

    <section class="rule-card">
      <h3>72 å°æ™‚é‡ç½®</h3>
      <p>ç„¡è«–æˆåŠŸæˆ–å¤±æ•—ï¼Œçš†ä»¥ã€Œåˆ·æ–°å¾Œ +72 å°æ™‚ã€é‡ç½®ï¼›é‡ç½®å¾Œå¯èƒ½å‡ºç¾åœ¨å…¶ä»–é»ä½ã€‚</p>
    </section>

    <section class="rule-card">
      <h3>é­”éˆå‡ºç¾è¦å‰‡ï¼ˆå°ç…§ï¼‰</h3>
      <ul>
        <li>ç¬¬ 1 å¤©ï¼šæˆåŠŸ â†’ ç¬¬ 2ã€3 å¤©ä¸é¡¯ç¤ºï¼›å¤±æ•— â†’ ç¬¬ 2ã€3 å¤©é¡¯ç¤º</li>
        <li>ç¬¬ 2 å¤©ï¼šæˆåŠŸ â†’ ç¬¬ 3 å¤©ä¸é¡¯ç¤ºï¼›å¤±æ•— â†’ ç¬¬ 3 å¤©é¡¯ç¤º</li>
        <li>ç¬¬ 3 å¤©ï¼šæˆåŠŸ / å¤±æ•— â†’ éé»ç­‰å¾…åˆ·æ–°</li>
      </ul>
    </section>
  </div>
</dialog>

</header>

<main>
  <div id="mapWrap">
    <aside id="legend" aria-label="é»ä½ç‹€æ…‹èªªæ˜èˆ‡çµ±è¨ˆ"></aside>

    <div id="mapContainer">
      <img id="mapImg" alt="map" />
    </div>
  </div>

  <input id="fileMap" type="file" accept="image/*" style="display:none" />
  <input id="fileImport" type="file" accept="application/json,.json" style="display:none" />

  <!-- âœ… åœ°åœ–æ’åº Modal -->
  <div id="sortModal" hidden aria-hidden="true">
    <div class="sort-panel" role="dialog" aria-modal="true" aria-label="èª¿æ•´åœ°åœ–é †åº">
      <div class="sort-head">
        <div>
          <div class="sort-title">ğŸ”– æ‹–æ›³èª¿æ•´åœ°åœ–é †åº</div>
          <div class="sort-sub">æœƒå½±éŸ¿ã€Œåœ°åœ–ä¸‹æ‹‰ã€èˆ‡ã€Œå·¦å´çµ±è¨ˆã€çš„é †åºï¼Œä¸æœƒå½±éŸ¿ä»»ä½•é»ä½ã€‚</div>
        </div>
        <div class="sort-actions">
          <button id="btnSortCancel" type="button">å–æ¶ˆ</button>
          <button id="btnSortDone" type="button" class="primary">å®Œæˆ</button>
        </div>
      </div>
      <ul id="sortList"></ul>
    </div>
  </div>
</main>

<script>
/* =====================
   âœ… å®‰å…¨é™åˆ¶ï¼ˆä½ å¯èª¿æ•´ï¼‰
===================== */
const IMPORT_MAX_BYTES = 3 * 1024 * 1024;   // 3MBï¼šå°å…¥ JSON æª”ä¸Šé™
const IMPORT_MAX_MARKERS = 5000;            // marker ä¸Šé™ï¼ˆé¿å… DOM çˆ†ç‚¸ï¼‰
const ALLOW_EXPORT_BASE64_MAPS = false;     // åŒ¯å‡ºä¸å« base64

/* =====================
   ç‹€æ…‹åœ–ç¤º & æ–‡å­—
===================== */
const stateIcons = ["icons/state0.png","icons/state1.png","icons/state2.png","icons/state3.png"];
const stateLegend = ["é‚„æ²’çœ‹","æŠ“åˆ°äº†","æ²’é­”éˆ","å¤±æ•— / éœ€å†è©¦"];
const STORAGE_KEY = "mapTaskTool_v4";

/* =====================
   é è¨­è³‡æ–™
===================== */
function createDefaultData(){
  return {
    maps: [
      { id: uid(), name: "æ·¨ç•Œå³¶", src: "maps/map1.png" },
      { id: uid(), name: "å†°æ¹–åŸæ±å€", src: "maps/map2.png" },
      { id: uid(), name: "å†°æ¹–åŸä¸‹æ°´é“", src: "maps/map3.png" },
      { id: uid(), name: "æ ¼é›·å§†å»¢ç¤¦", src: "maps/map4.png" },
      { id: uid(), name: "é¾èè¦å¡-å€åŸŸ1", src: "maps/map5.png" },
      { id: uid(), name: "é¾èè¦å¡-å€åŸŸ2", src: "maps/map6.png" },
    ],
    markers: [],
    currentMapId: null
  };
}

let data = createDefaultData();
let mode = "normal";

/* =====================
   DOM
===================== */
const mapSelect = document.getElementById("mapSelect");
const mapNameInput = document.getElementById("mapName");
const mapImg = document.getElementById("mapImg");
const mapContainer = document.getElementById("mapContainer");
const modeLabel = document.getElementById("modeLabel");
const legendEl = document.getElementById("legend");

const btnAddMarker = document.getElementById("btnAddMarker");
const btnDeleteMarker = document.getElementById("btnDeleteMarker");
const btnResetAll = document.getElementById("btnResetAll");
const btnDeleteMarkersCurrent = document.getElementById("btnDeleteMarkersCurrent");
const btnDeleteAllMarkers = document.getElementById("btnDeleteAllMarkers");

const btnAddMap = document.getElementById("btnAddMap");
const btnDeleteMap = document.getElementById("btnDeleteMap");
const btnReplaceMapImage = document.getElementById("btnReplaceMapImage");
const btnSortMaps = document.getElementById("btnSortMaps");

const fileMap = document.getElementById("fileMap");

const btnExport = document.getElementById("btnExport");
const btnImport = document.getElementById("btnImport");
const fileImport = document.getElementById("fileImport");
const btnClearAll = document.getElementById("btnClearAll");

/* åœ°åœ–æ’åº Modal DOM */
const sortModal = document.getElementById("sortModal");
const sortList = document.getElementById("sortList");
const btnSortDone = document.getElementById("btnSortDone");
const btnSortCancel = document.getElementById("btnSortCancel");

/* =====================
   åˆå§‹åŒ–
===================== */
load();
if (!data.currentMapId && data.maps.length) data.currentMapId = data.maps[0].id;
renderMapSelect();
syncCurrentMapUI();
render();

/* =====================
   äº‹ä»¶ï¼šåœ°åœ–åˆ‡æ› / æ”¹å
===================== */
mapSelect.addEventListener("change", () => {
  data.currentMapId = mapSelect.value;
  setMode("normal");
  syncCurrentMapUI();
  save();
  render();
});

mapNameInput.addEventListener("input", () => {
  const m = getCurrentMap();
  if (!m) return;
  m.name = mapNameInput.value.trim() || "æœªå‘½ååœ°åœ–";
  renderMapSelect(true);
  save();
  renderLegendAndStats();
});

/* =====================
   æ¨¡å¼æŒ‰éˆ•ï¼ˆæ–°å¢/åˆªé™¤é»ä½ï¼‰
===================== */
btnAddMarker.addEventListener("click", () => setMode(mode === "addMarker" ? "normal" : "addMarker"));
btnDeleteMarker.addEventListener("click", () => setMode(mode === "deleteMarker" ? "normal" : "deleteMarker"));

/* =====================
   ä¸€éµé‡ç½®ï¼ˆä¿ç•™é»ä½ï¼Œåªæ”¹ç‹€æ…‹ï¼‰
===================== */
btnResetAll.addEventListener("click", () => {
  if (!confirm("ç¢ºå®šè¦æŠŠã€æ‰€æœ‰åœ°åœ–ã€‘çš„ã€æ‰€æœ‰é»ä½ã€‘éƒ½é‡ç½®æˆç‹€æ…‹ 0ï¼Ÿ")) return;
  data.markers.forEach(m => m.state = 0);
  save();
  render();
});

/* =====================
   âœ… æ¸…ç©ºæœ¬åœ°åœ–é»ä½ï¼ˆåªåˆªç›®å‰ mapIdï¼‰
===================== */
btnDeleteMarkersCurrent.addEventListener("click", () => {
  const m = getCurrentMap();
  if (!m) return;

  const currentCount = data.markers.filter(x => x.mapId === m.id).length;
  if (currentCount === 0) {
    alert(`ã€Œ${m.name}ã€ç›®å‰æ²’æœ‰ä»»ä½•é»ä½å¯åˆªé™¤ã€‚`);
    return;
  }

  const ok = confirm(
    `âš ï¸ ç¢ºå®šè¦æ¸…ç©ºåœ°åœ–ã€Œ${m.name}ã€çš„æ‰€æœ‰é»ä½å—ï¼Ÿ\n` +
    `æœ¬æ¬¡æœƒåˆªé™¤ï¼š${currentCount} å€‹é»ä½\n` +
    `ï¼ˆä¸æœƒå½±éŸ¿å…¶ä»–åœ°åœ–çš„é»ä½ï¼‰`
  );
  if (!ok) return;

  data.markers = data.markers.filter(x => x.mapId !== m.id);
  save();
  render();
});

/* =====================
   âœ… åˆªé™¤æ‰€æœ‰é»ä½ï¼ˆåªæ¸…ç©º markersï¼‰
===================== */
btnDeleteAllMarkers.addEventListener("click", () => {
  if (data.markers.length === 0) {
    alert("ç›®å‰æ²’æœ‰ä»»ä½•é»ä½å¯åˆªé™¤ã€‚");
    return;
  }

  const ok = confirm(
    "âš ï¸ ç¢ºå®šè¦ã€åˆªé™¤æ‰€æœ‰åœ°åœ–ã€‘çš„ã€å…¨éƒ¨é»ä½ã€‘å—ï¼Ÿ\n" +
    "ï¼ˆåªæœƒåˆªé»ä½ï¼Œä¸æœƒåˆªåœ°åœ–ã€ä¹Ÿä¸æœƒæ›´å‹•å…¶ä»–è¨­å®šï¼‰"
  );
  if (!ok) return;

  data.markers = [];
  save();
  render();
});

/* =====================
   æ–°å¢åœ°åœ–ï¼ˆä¸Šå‚³æœƒè½‰ base64ï¼‰
===================== */
btnAddMap.addEventListener("click", () => {
  const name = prompt("è«‹è¼¸å…¥æ–°åœ°åœ–åç¨±ï¼š", `åœ°åœ– ${data.maps.length + 1}`);
  if (name === null) return;

  fileMap.value = "";
  fileMap.click();

  fileMap.onchange = async () => {
    const file = fileMap.files?.[0];
    if (!file) return;

    const src = await fileToDataURL(file);
    const newMap = { id: uid(), name: (name.trim() || "æœªå‘½ååœ°åœ–"), src };

    data.maps.push(newMap);
    data.currentMapId = newMap.id;

    setMode("normal");
    renderMapSelect();
    syncCurrentMapUI();
    save();
    render();
  };
});

/* =====================
   åˆªé™¤åœ°åœ–ï¼ˆå«è©²åœ–æ‰€æœ‰é»ä½ï¼‰
===================== */
btnDeleteMap.addEventListener("click", () => {
  const m = getCurrentMap();
  if (!m) return;

  const ok = confirm(`ç¢ºå®šè¦åˆªé™¤åœ°åœ–ã€Œ${m.name}ã€ï¼Ÿ\nï¼ˆè©²åœ°åœ–çš„æ‰€æœ‰é»ä½ä¹Ÿæœƒä¸€ä½µåˆªé™¤ï¼‰`);
  if (!ok) return;

  data.maps = data.maps.filter(x => x.id !== m.id);
  data.markers = data.markers.filter(mm => mm.mapId !== m.id);
  data.currentMapId = data.maps[0]?.id ?? null;

  setMode("normal");
  renderMapSelect();
  syncCurrentMapUI();
  save();
  render();
});

/* =====================
   ğŸ” é‡æ–°ä¸Šå‚³æ­¤åœ°åœ–åœ–ç‰‡
===================== */
btnReplaceMapImage.addEventListener("click", () => {
  const m = getCurrentMap();
  if (!m) {
    alert("ç›®å‰æ²’æœ‰é¸æ“‡ä»»ä½•åœ°åœ–ã€‚");
    return;
  }

  const ok = confirm(
    `ä½ å³å°‡é‡æ–°ä¸Šå‚³åœ°åœ–åœ–ç‰‡ï¼š\nã€Œ${m.name}ã€\n\n` +
    "é€™åªæœƒæ›´æ›åœ–ç‰‡ï¼Œä¸æœƒå½±éŸ¿ä»»ä½•é»ä½æˆ–ç‹€æ…‹ã€‚\n\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ"
  );
  if (!ok) return;

  fileMap.value = "";
  fileMap.click();

  fileMap.onchange = async () => {
    const file = fileMap.files?.[0];
    if (!file) return;

    try {
      const src = await fileToDataURL(file);
      m.src = src;
      m.needsMapUpload = false;

      save();
      render();
      alert(`âœ… åœ°åœ–ã€Œ${m.name}ã€å·²æˆåŠŸé‡æ–°ä¸Šå‚³åœ–ç‰‡`);
    } catch (err) {
      console.error(err);
      alert("âŒ ä¸Šå‚³å¤±æ•—ï¼Œè«‹ç¢ºèªæª”æ¡ˆæ˜¯å¦ç‚ºåœ–ç‰‡ã€‚");
    }
  };
});

/* =====================
   ğŸ”– åœ°åœ–æ’åºï¼ˆæ‹–æ›³ï¼‰
===================== */
btnSortMaps.addEventListener("click", () => {
  openSortModal();
});

function openSortModal(){
  sortList.innerHTML = "";

  data.maps.forEach(mp => {
    const li = document.createElement("li");
    li.draggable = true;
    li.dataset.id = mp.id;

    li.innerHTML = `
      <span class="drag-handle">â‰¡</span>
      <span class="sort-name">${escapeHtml(mp.name || "æœªå‘½ååœ°åœ–")}</span>
    `;
    sortList.appendChild(li);
  });

  sortModal.hidden = false;
  sortModal.setAttribute("aria-hidden", "false");

  initDragSort();
}

function closeSortModal(){
  sortModal.hidden = true;
  sortModal.setAttribute("aria-hidden", "true");
  sortList.innerHTML = "";
}

btnSortCancel.addEventListener("click", closeSortModal);

/* é»é»‘åº•é—œé–‰ï¼ˆåªé»åˆ°èƒŒæ™¯æ‰é—œï¼‰ */
sortModal.addEventListener("click", (e) => {
  if (e.target === sortModal) closeSortModal();
});

document.addEventListener("keydown", (e) => {
  if (e.key === "Escape" && !sortModal.hidden) closeSortModal();
});

btnSortDone.addEventListener("click", () => {
  const newOrder = Array.from(sortList.children).map(li => li.dataset.id);

  data.maps.sort((a, b) => newOrder.indexOf(a.id) - newOrder.indexOf(b.id));

  save();
  renderMapSelect(true);
  renderLegendAndStats();
  closeSortModal();
});

function initDragSort(){
  const items = Array.from(sortList.querySelectorAll("li"));
  let dragging = null;

  items.forEach(li => {
    li.addEventListener("dragstart", () => {
      dragging = li;
      li.classList.add("dragging");
    });

    li.addEventListener("dragend", () => {
      li.classList.remove("dragging");
      dragging = null;
    });

    li.addEventListener("dragover", (e) => {
      e.preventDefault();
      const target = li;
      if (!dragging || target === dragging) return;

      const rect = target.getBoundingClientRect();
      const after = e.clientY > rect.top + rect.height / 2;
      sortList.insertBefore(dragging, after ? target.nextSibling : target);
    });
  });
}

/* =====================
   åœ°åœ–é»æ“Šï¼šæ–°å¢é»ä½ï¼ˆæŒçºŒæ¨¡å¼ï¼‰
===================== */
mapContainer.addEventListener("click", (e) => {
  const m = getCurrentMap();
  if (!m) return;
  if (mode !== "addMarker") return;

  const rect = mapContainer.getBoundingClientRect();
  const x = (e.clientX - rect.left) / rect.width;
  const y = (e.clientY - rect.top) / rect.height;

  data.markers.push({ id: uid(), mapId: m.id, x: clamp01(x), y: clamp01(y), state: 0 });
  save();
  render();
});

/* =====================
   âœ… åŒ¯å‡ºï¼ˆè¼•é‡ï¼‰
===================== */
btnExport.addEventListener("click", () => {
  const lite = buildExportLiteData();
  const payload = { exportedAt: new Date().toISOString(), version: 1, data: lite };
  const json = JSON.stringify(payload, null, 2);

  const blob = new Blob([json], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `map-task-data-lite-${formatDateForFile(new Date())}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(a.href), 1000);
});

/* =====================
   âœ… å°å…¥
===================== */
btnImport.addEventListener("click", () => {
  fileImport.value = "";
  fileImport.click();
});

fileImport.addEventListener("change", async () => {
  const file = fileImport.files?.[0];
  if (!file) return;

  if (file.size > IMPORT_MAX_BYTES) {
    alert(`âŒ å°å…¥å¤±æ•—ï¼šæª”æ¡ˆå¤ªå¤§ï¼ˆ${formatBytes(file.size)}ï¼‰ã€‚\nä¸Šé™ç‚º ${formatBytes(IMPORT_MAX_BYTES)}ã€‚`);
    return;
  }

  try {
    const text = await file.text();
    const parsed = JSON.parse(text);
    const incoming = parsed?.data ? parsed.data : parsed;

    const incomingMarkers = Array.isArray(incoming?.markers) ? incoming.markers.length : 0;
    if (incomingMarkers > IMPORT_MAX_MARKERS) {
      alert(`âŒ å°å…¥å¤±æ•—ï¼šé»ä½æ•¸é‡éå¤šï¼ˆ${incomingMarkers}ï¼‰ã€‚\nä¸Šé™ç‚º ${IMPORT_MAX_MARKERS}ã€‚`);
      return;
    }

    assertValidData(incoming);

    const ok = confirm(
      "å°å…¥æœƒã€è¦†è“‹ã€‘ä½ ç›®å‰çš„æ‰€æœ‰åœ°åœ–/é»ä½/ç‹€æ…‹ã€‚\n" +
      "å»ºè­°å…ˆåŒ¯å‡ºå‚™ä»½å†å°å…¥ã€‚\n\nç¢ºå®šè¦å°å…¥å—ï¼Ÿ"
    );
    if (!ok) return;

    data = incoming;

    if (!data.currentMapId || !data.maps.some(m => m.id === data.currentMapId)) {
      data.currentMapId = data.maps[0]?.id ?? null;
    }

    setMode("normal");
    renderMapSelect();
    syncCurrentMapUI();
    save();
    render();

    const needMaps = data.maps.filter(m => m.needsMapUpload === true);
    if (needMaps.length > 0) {
      alert("âœ… å°å…¥å®Œæˆï¼\nâš ï¸ æœ‰éƒ¨åˆ†åœ°åœ–éœ€è¦é‡æ–°ä¸Šå‚³åœ–ç‰‡ï¼ˆåŒ¯å‡ºè³‡æ–™ä¸åŒ…å«è‡ªè¨‚åœ°åœ–ï¼‰ã€‚");
    } else {
      alert("âœ… å°å…¥å®Œæˆï¼");
    }
  } catch (err) {
    console.error(err);
    alert("âŒ å°å…¥å¤±æ•—ï¼šJSON æ ¼å¼ä¸æ­£ç¢ºæˆ–è³‡æ–™å…§å®¹ä¸ç¬¦åˆå·¥å…·æ ¼å¼ã€‚");
  }
});

/* =====================
   âœ… æ¸…ç©ºæ‰€æœ‰è³‡æ–™
===================== */
btnClearAll.addEventListener("click", () => {
  const ok = confirm(
    "âš ï¸ æ¸…ç©ºæ‰€æœ‰è³‡æ–™æœƒï¼š\n" +
    "1) åˆªé™¤æœ¬å·¥å…·çš„ localStorage è¨˜éŒ„\n" +
    "2) æ¸…ç©ºæ‰€æœ‰é»ä½ã€é‚„åŸé è¨­åœ°åœ–æ¸…å–®\n\n" +
    "å»ºè­°å…ˆåŒ¯å‡ºå‚™ä»½ã€‚\n\nç¢ºå®šè¦æ¸…ç©ºå—ï¼Ÿ"
  );
  if (!ok) return;

  localStorage.removeItem(STORAGE_KEY);

  data = createDefaultData();
  data.currentMapId = data.maps[0]?.id ?? null;

  setMode("normal");
  renderMapSelect();
  syncCurrentMapUI();
  render();

  alert("âœ… å·²æ¸…ç©ºå®Œæˆï¼ˆå›åˆ°åˆå§‹ç‹€æ…‹ï¼‰");
});

/* =====================
   Render
===================== */
function render(){
  renderLegendAndStats();

  const m = getCurrentMap();
  mapImg.src = m?.src || "";

  document.querySelectorAll(".marker").forEach(el => el.remove());
  if (!m) return;

  data.markers.filter(mm => mm.mapId === m.id).forEach(mm => {
    const el = document.createElement("img");
    el.className = "marker";
    el.src = stateIcons[mm.state] || stateIcons[0];
    el.style.left = (mm.x * 100) + "%";
    el.style.top  = (mm.y * 100) + "%";

    el.title = (mode === "deleteMarker") ? "é»ä¸€ä¸‹åˆªé™¤é€™å€‹é»ä½" : "é»ä¸€ä¸‹åˆ‡æ›ç‹€æ…‹ï¼ˆå…± 4 ç¨®ï¼‰";

    el.addEventListener("click", (ev) => {
      ev.stopPropagation();

      if (mode === "deleteMarker") {
        const ok = confirm("åˆªé™¤é€™å€‹é»ä½ï¼Ÿ");
        if (!ok) return;
        data.markers = data.markers.filter(x => x.id !== mm.id);
        save();
        render();
        return;
      }

      mm.state = (mm.state + 1) % stateIcons.length;
      el.src = stateIcons[mm.state];
      save();
      renderLegendAndStats();
    });

    mapContainer.appendChild(el);
  });

  modeLabel.textContent =
    mode === "normal" ? "ä¸€èˆ¬" :
    mode === "addMarker" ? "æ–°å¢é»ä½" : "åˆªé™¤é»ä½";
}

function renderLegendAndStats(){
  if (!legendEl) return;

  const legendItems = stateIcons.map((src, i) => {
    const text = stateLegend[i] ?? `ç‹€æ…‹ ${i}`;
    return `
      <div class="legend-item">
        <img class="legend-icon" src="${src}" alt="ç‹€æ…‹${i}">
        <div class="legend-text">${escapeHtml(text)}</div>
        <div class="legend-state">#${i}</div>
      </div>
    `;
  }).join("");

  const countsByMap = computeCountsByMap();

  const statsRows = data.maps.map(mp => {
    const c = countsByMap.get(mp.id) || { s1: 0, s3: 0 };
    return `
      <div class="stats-row">
        <div class="stats-name">${escapeHtml(mp.name || "æœªå‘½ååœ°åœ–")}</div>
        <div class="stats-counts">
          <span class="pill" title="state1 æ•¸é‡">
            <img src="${stateIcons[1]}" alt="s1"> ${c.s1}
          </span>
          <span class="pill" title="state3 æ•¸é‡">
            <img src="${stateIcons[3]}" alt="s3"> ${c.s3}
          </span>
        </div>
      </div>
    `;
  }).join("");

  const failedMaps = data.maps
    .filter(mp => (countsByMap.get(mp.id)?.s3 ?? 0) > 0)
    .map(mp => `<div class="fail-item">ä¸Šæ¬¡ã€Œ${escapeHtml(mp.name || "æœªå‘½ååœ°åœ–")}ã€æœ‰é­”éˆæ•æ‰å¤±æ•—</div>`)
    .join("");

  const failBlock = failedMaps
    ? `<div class="fail-title">æé†’</div>${failedMaps}`
    : `<div class="fail-title">æé†’</div><div class="fail-empty">ç›®å‰æ²’æœ‰é­”éˆæ•æ‰å¤±æ•—ã€‚</div>`;

  legendEl.innerHTML = `
    <div class="legend-title">é»ä½ç‹€æ…‹</div>
    ${legendItems}

    <div class="panel-sep"></div>

    <div class="stats-title">åœ°åœ–çµ±è¨ˆ</div>
    ${statsRows}

    <div class="panel-sep"></div>
    ${failBlock}
  `;
}

function computeCountsByMap(){
  const state1Index = 1;
  const state3Index = 3;

  const map = new Map();
  for (const mp of data.maps) map.set(mp.id, { s1: 0, s3: 0 });

  for (const mk of data.markers) {
    const row = map.get(mk.mapId);
    if (!row) continue;
    if (mk.state === state1Index) row.s1 += 1;
    if (mk.state === state3Index) row.s3 += 1;
  }
  return map;
}

function renderMapSelect(preserveSelection = false){
  const current = data.currentMapId;
  mapSelect.innerHTML = "";

  data.maps.forEach((m, i) => {
    const opt = document.createElement("option");
    opt.value = m.id;
    opt.textContent = m.name || `åœ°åœ– ${i + 1}`;
    mapSelect.appendChild(opt);
  });

  if (preserveSelection && current) mapSelect.value = current;
  if (!preserveSelection && data.currentMapId) mapSelect.value = data.currentMapId;
}

function syncCurrentMapUI(){
  const m = getCurrentMap();
  mapNameInput.value = m?.name || "";
  if (m?.id) mapSelect.value = m.id;
}

function setMode(next){
  mode = next;
  btnAddMarker.classList.toggle("active", mode === "addMarker");
  btnDeleteMarker.classList.toggle("active", mode === "deleteMarker");
  render();
}

/* =====================
   localStorage
===================== */
function save(){
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  } catch (e) {
    alert("ä¿å­˜å¤±æ•—ï¼šlocalStorage ç©ºé–“å¯èƒ½ä¸å¤ ï¼ˆåœ°åœ–åœ–ç‰‡å¤ªå¤§ï¼‰ã€‚\nå»ºè­°ç¸®å°åœ–ç‰‡æˆ–æ¸›å°‘ä¸Šå‚³åœ°åœ–ã€‚");
  }
}

function load(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return;
  try {
    const parsed = JSON.parse(raw);
    if (parsed?.maps && parsed?.markers) data = parsed;
  } catch {}
}

/* =====================
   åŒ¯å‡ºã€Œè¼•é‡ dataã€
===================== */
function buildExportLiteData(){
  const lite = {
    maps: [],
    markers: data.markers.map(mk => ({ ...mk })),
    currentMapId: data.currentMapId
  };

  for (const mp of data.maps) {
    const isBase64 = typeof mp.src === "string" && mp.src.startsWith("data:image/");
    if (!ALLOW_EXPORT_BASE64_MAPS && isBase64) {
      lite.maps.push({ id: mp.id, name: mp.name, src: "", needsMapUpload: true });
    } else {
      lite.maps.push({ id: mp.id, name: mp.name, src: mp.src, needsMapUpload: !!mp.needsMapUpload });
    }
  }
  return lite;
}

/* =====================
   å°å…¥é©—è­‰/ä¿®æ­£
===================== */
function assertValidData(d){
  if (!d || typeof d !== "object") throw new Error("data not object");
  if (!Array.isArray(d.maps) || !Array.isArray(d.markers)) throw new Error("missing maps/markers");

  for (const m of d.maps) {
    if (!m || typeof m !== "object") throw new Error("bad map");
    if (typeof m.id !== "string") throw new Error("map.id missing");
    if (typeof m.name !== "string") m.name = "æœªå‘½ååœ°åœ–";
    if (typeof m.src !== "string") m.src = "";
    if (typeof m.needsMapUpload !== "boolean") m.needsMapUpload = (m.src === "");
  }

  for (const mk of d.markers) {
    if (!mk || typeof mk !== "object") throw new Error("bad marker");
    if (typeof mk.id !== "string") throw new Error("marker.id missing");
    if (typeof mk.mapId !== "string") throw new Error("marker.mapId missing");
    if (typeof mk.x !== "number" || typeof mk.y !== "number") throw new Error("marker.x/y missing");
    if (typeof mk.state !== "number") mk.state = 0;

    mk.state = ((mk.state % stateIcons.length) + stateIcons.length) % stateIcons.length;
    mk.x = clamp01(mk.x);
    mk.y = clamp01(mk.y);
  }

  if (d.currentMapId !== null && typeof d.currentMapId !== "string") d.currentMapId = null;

  const mapIds = new Set(d.maps.map(m => m.id));
  d.markers = d.markers.filter(mk => mapIds.has(mk.mapId));
}

/* =====================
   å·¥å…·å‡½å¼
===================== */
function getCurrentMap(){
  return data.maps.find(m => m.id === data.currentMapId) || null;
}

function uid(){
  return (crypto?.randomUUID?.() || ("id_" + Math.random().toString(16).slice(2) + Date.now()));
}

function clamp01(n){ return Math.min(1, Math.max(0, n)); }

function fileToDataURL(file){
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

function escapeHtml(s){
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function formatDateForFile(dt){
  const y = dt.getFullYear();
  const m = String(dt.getMonth() + 1).padStart(2, "0");
  const d = String(dt.getDate()).padStart(2, "0");
  const hh = String(dt.getHours()).padStart(2, "0");
  const mm = String(dt.getMinutes()).padStart(2, "0");
  return `${y}${m}${d}-${hh}${mm}`;
}

function formatBytes(bytes){
  const units = ["B", "KB", "MB", "GB"];
  let n = bytes;
  let i = 0;
  while (n >= 1024 && i < units.length - 1) { n /= 1024; i++; }
  return `${n.toFixed(i === 0 ? 0 : 2)} ${units[i]}`;
}

/* =====================
   âœ… ä¸‹æ‹‰é¸å–®è¡Œç‚ºï¼šåªé»æ“Šæ‰å±•é–‹/å†æ¬¡é»æ”¶èµ·
===================== */
(function initDropdowns(){
  const dropdowns = Array.from(document.querySelectorAll("[data-dd]"));

  function closeAll(except = null){
    dropdowns.forEach(dd => {
      if (dd === except) return;
      dd.classList.remove("open");
      const btn = dd.querySelector(".menu-btn");
      if (btn) btn.setAttribute("aria-expanded", "false");
    });
  }

  dropdowns.forEach(dd => {
    const btn = dd.querySelector(".menu-btn");
    const menu = dd.querySelector(".menu");
    if (!btn || !menu) return;

    btn.addEventListener("click", (e) => {
      e.stopPropagation();
      const isOpen = dd.classList.contains("open");
      if (isOpen) {
        dd.classList.remove("open");
        btn.setAttribute("aria-expanded", "false");
      } else {
        closeAll(dd);
        dd.classList.add("open");
        btn.setAttribute("aria-expanded", "true");
      }
    });

    menu.addEventListener("click", (e) => {
      const target = e.target;
      if (target && target.tagName === "BUTTON") {
        dd.classList.remove("open");
        btn.setAttribute("aria-expanded", "false");
      }
    });
  });

  document.addEventListener("click", () => closeAll(null));

  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape") closeAll(null);
  });
})();
/* ===== é­”éˆåˆ·æ–°è¦å‰‡ Dialog ===== */
(() => {
  const btnOpen = document.getElementById("btnOpenRules");
  const dlg = document.getElementById("ruleDialog");
  const btnClose = document.getElementById("btnCloseRules");

  if (!btnOpen || !dlg) return;

  btnOpen.addEventListener("click", () => dlg.showModal());
  btnClose.addEventListener("click", () => dlg.close());

  // é»æ“Š dialog å¤–åœé—œé–‰
  dlg.addEventListener("click", (e) => {
    const r = dlg.getBoundingClientRect();
    const inside =
      e.clientX >= r.left && e.clientX <= r.right &&
      e.clientY >= r.top  && e.clientY <= r.bottom;
    if (!inside) dlg.close();
  });

  // ESC é—œé–‰
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && dlg.open) dlg.close();
  });
})();

</script>
</body>
</html>
