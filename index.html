<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>é­”éˆæ¨™ç¤ºè¼”åŠ©å™¨</title>

<style>
  :root { color-scheme: dark; }
  body {
    margin: 0;
    background:#111;
    color:#fff;
    font-family: system-ui, -apple-system, "Segoe UI", "Noto Sans TC", sans-serif;
  }

  header {
    position: sticky;
    top: 0;
    background: rgba(17,17,17,.92);
    backdrop-filter: blur(8px);
    border-bottom: 1px solid rgba(255,255,255,.08);
    padding: 12px 14px;
    z-index: 10;
  }

  h1 {
    margin: 0 0 10px 0;
    font-size: 18px;
    font-weight: 650;
  }

  .row {
    display:flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }

  select, input[type="text"], button {
    background:#1b1b1b;
    color:#fff;
    border:1px solid rgba(255,255,255,.14);
    border-radius: 10px;
    padding: 8px 10px;
    font-size: 14px;
    outline: none;
  }

  input[type="text"] { width: 220px; }
  button { cursor:pointer; }

  button.primary { border-color: rgba(130,200,255,.6); }
  button.danger  { border-color: rgba(255,120,120,.6); }

  button.active {
    border-color: rgba(120,255,180,.7);
    box-shadow: 0 0 0 2px rgba(120,255,180,.15) inset;
  }

  .hint {
    margin-top: 10px;
    font-size: 12px;
    color: rgba(255,255,255,.72);
    line-height: 1.45;
  }

  .hint-strong { color: #fbbf24; font-weight: 650; }
  .hint-info   { color: #7dd3fc; }
  .hint-title  { color: #a7f3d0; font-weight: 650; }
  .hint-warning{ color: #fb7185; font-weight: 650; }

  .hint-line { margin: 4px 0; }
  .hint-details {
    margin-top: 10px;
    padding-top: 8px;
    border-top: 1px solid rgba(255,255,255,.10);
  }
  .hint-details summary {
    cursor: pointer;
    color: rgba(255,255,255,.85);
    font-weight: 650;
    list-style: none;
    user-select: none;
  }
  .hint-details summary::-webkit-details-marker { display: none; }
  .hint-block { margin-top: 10px; }
  .hint-subtitle { font-weight: 650; color: rgba(255,255,255,.90); margin-bottom: 4px; }
  .hint-text { color: rgba(255,255,255,.75); }
  .hint-list { margin: 6px 0 0 18px; padding: 0; }
  .hint-list li { margin: 4px 0; }

  main { padding: 14px; }

  #mapWrap {
    display: flex;
    gap: 12px;
    align-items: flex-start;
    justify-content: center;
  }

  #legend {
    width: 260px;
    max-width: 45vw;
    background: rgba(255,255,255,.04);
    border: 1px solid rgba(255,255,255,.10);
    border-radius: 14px;
    padding: 10px;
    position: sticky;
    top: 92px;
  }

  .legend-title {
    font-size: 13px;
    font-weight: 700;
    margin: 2px 0 10px 0;
    color: rgba(255,255,255,.90);
  }

  .legend-item {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 8px 8px;
    border-radius: 12px;
  }
  .legend-item:hover { background: rgba(255,255,255,.05); }

  .legend-icon {
    width: 22px;
    height: 22px;
    border-radius: 6px;
    flex: 0 0 auto;
  }

  .legend-text { font-size: 13px; color: rgba(255,255,255,.82); line-height: 1.2; }
  .legend-state { font-size: 12px; color: rgba(255,255,255,.55); margin-left: auto; }

  .panel-sep { margin: 10px 0; border-top: 1px solid rgba(255,255,255,.10); }

  .stats-title {
    font-size: 13px;
    font-weight: 700;
    margin: 10px 0 8px 0;
    color: rgba(255,255,255,.90);
  }

  .stats-row {
    display:flex;
    align-items:center;
    gap: 8px;
    padding: 7px 8px;
    border-radius: 12px;
  }
  .stats-row:hover { background: rgba(255,255,255,.05); }

  .stats-name {
    font-size: 13px;
    color: rgba(255,255,255,.86);
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    flex: 1 1 auto;
  }

  .stats-counts {
    display:flex;
    gap: 10px;
    flex: 0 0 auto;
    font-size: 12px;
    color: rgba(255,255,255,.68);
  }

  .pill {
    display:inline-flex;
    align-items:center;
    gap: 6px;
    padding: 3px 8px;
    border-radius: 999px;
    border: 1px solid rgba(255,255,255,.12);
    background: rgba(0,0,0,.12);
  }
  .pill img { width: 14px; height: 14px; border-radius: 4px; }

  .fail-title {
    font-size: 13px;
    font-weight: 700;
    margin: 10px 0 8px 0;
    color: rgba(255,255,255,.90);
  }
  .fail-item {
    font-size: 12px;
    color: rgba(255,255,255,.72);
    padding: 6px 8px;
    border-radius: 12px;
    border: 1px dashed rgba(255,120,120,.35);
    background: rgba(255,120,120,.06);
    margin: 6px 0;
    line-height: 1.35;
  }
  .fail-empty { font-size: 12px; color: rgba(255,255,255,.55); padding: 6px 8px; }

  #mapContainer {
    position: relative;
    display: inline-block;
    margin: 8px auto 18px auto;
    border-radius: 14px;
    overflow: hidden;
    box-shadow: 0 10px 40px rgba(0,0,0,.35);
    border: 1px solid rgba(255,255,255,.08);
    max-width: min(1200px, 96vw);
  }

  #mapImg { display:block; width: 100%; height: auto; }

  .marker {
    position:absolute;
    width: 30px;
    height: 30px;
    transform: translate(-50%, -50%);
    cursor: pointer;
    user-select: none;
  }
  .marker:hover { filter: drop-shadow(0 0 6px rgba(255,255,255,.25)); }

  .badge {
    display:inline-flex;
    align-items:center;
    gap:6px;
    padding: 6px 10px;
    border:1px dashed rgba(255,255,255,.18);
    border-radius: 999px;
    font-size: 12px;
    color: rgba(255,255,255,.8);
  }
  .badge b { color: rgba(255,255,255,.95); }

  @media (max-width: 920px) {
    #mapWrap { flex-direction: column; align-items: center; }
    #legend { width: min(640px, 96vw); position: relative; top: 0; }
  }
  /* âœ… å°è¢å¹•ï¼šä¸Šä¸‹æ’åˆ—ã€å­—è®Šå¤§ã€æŒ‰éˆ•æ›´å¥½é»ï¼ˆæ‰‹æ©Ÿæœ€èˆ’æœï¼‰ */
@media (max-width: 920px) {
  header { padding: 10px 10px; }
  h1 { font-size: 16px; }

  .row { gap: 8px; }
  select, input[type="text"], button {
    font-size: 15px;
    padding: 10px 12px;
    border-radius: 12px;
  }
  input[type="text"] { width: min(260px, 70vw); }

  #mapWrap { flex-direction: column; align-items: stretch; }
  #legend { width: auto; max-width: none; position: relative; top: 0; margin-bottom: 10px; }

  .hint { font-size: 13px; line-height: 1.55; }
  .marker { width: 34px; height: 34px; } /* æ‰‹æŒ‡å¥½é» */
}
/* âœ… åœ°åœ–ä¸è¦æŠŠç•«é¢åƒå…‰ï¼ˆé›»è…¦/æ‰‹æ©Ÿéƒ½æœ‰æ•ˆï¼‰ */
#mapContainer { max-height: calc(100vh - 240px); }
#mapImg {
  max-height: calc(100vh - 240px);
  object-fit: contain;
}

</style>
</head>

<body>
<header>
  <h1>ğŸ“ é­”éˆæ¨™ç¤ºè¼”åŠ©å™¨</h1>

  <div class="row">
    <span class="badge">æ¨¡å¼ï¼š<b id="modeLabel">ä¸€èˆ¬</b></span>

    <label>åœ°åœ–ï¼š
      <select id="mapSelect"></select>
    </label>

    <label>åç¨±ï¼š
      <input id="mapName" type="text" placeholder="åœ°åœ–åç¨±" />
    </label>

    <button class="primary" id="btnAddMarker">â• æ–°å¢é»ä½</button>
    <button id="btnDeleteMarker" class="danger">ğŸ—‘ï¸ åˆªé™¤é»ä½</button>
    <button id="btnResetAll">ğŸ”„ å…¨éƒ¨é»ä½é‡ç½®</button>

    <button class="primary" id="btnAddMap">ğŸ–¼ï¸ æ–°å¢åœ°åœ–</button>
    <button class="danger" id="btnDeleteMap">ğŸ§¨ åˆªé™¤åœ°åœ–</button>

    <button id="btnExport">â¬‡ï¸ åŒ¯å‡ºè³‡æ–™</button>
    <button id="btnImport">â¬†ï¸ å°å…¥è³‡æ–™</button>
    <button class="danger" id="btnClearAll">ğŸ§¹ æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
  </div>

  <div class="hint">
    <div class="hint-line">
      <span class="hint-strong">æ–°å¢é­”éˆé»ä½å‰ï¼Œå»ºè­°å…ˆåƒè€ƒæ”»ç•¥ã€‚</span>
      <span class="hint-info">ï¼ˆæœ¬å·¥å…·è‡ªå‹•ä¿å­˜ï¼‰</span>
    </div>

    <div class="hint-line">
      <span class="hint-title">åˆ·æ–°æ•¸é‡</span>ï¼š
      æ·¨ç•Œå³¶ 8ï½œå†°æ¹– ä¸»åŸ 4 / éƒŠå¤– 9 / æ´çªŸ&Boss 3ï½œä¸‹æ°´é“ 7ï½œå»¢ç¤¦ 7ï½œé¾èè¦å¡ 7
    </div>

    <div class="hint-line hint-warning">
      é”æ•æ‰ä¸Šé™å¾Œï¼ŒåŒåœ°åœ–å…¶é¤˜é»ä½å¯ç•¥éã€‚
    </div>

    <details class="hint-details">
      <summary>é­”éˆåˆ·æ–°è¦å‰‡ï¼ˆé»é–‹æŸ¥çœ‹ï¼‰</summary>

      <div class="hint-block">
        <div class="hint-subtitle">åˆ·æ–°é †åº</div>
        <div class="hint-text">
          3 â†’ 6 â†’ 2 â†’ 5 â†’ 1 â†’ 4 â†’ 7ï¼ˆå¾ªç’°ï¼‰<br>
          â€» æ­¤å¾ªç’°æŒ‡çš„æ˜¯ç¦®æ‹œä¸‰ã€å…­ã€äºŒã€äº”ã€ä¸€ã€å››ã€æ—¥<br>
          â€» åˆ·æ–°ã€Œèµ·é»ã€ä¾ä½ çš„ä¸Šç·šæ—¥æ¨å®šï¼šè‹¥é€±äºŒä¸Šç·šï¼Œä¸‹ä¸€æ¬¡åˆ·æ–°å¾é€±äº”æ¥çºŒã€‚
        </div>
      </div>

      <div class="hint-block">
        <div class="hint-subtitle">72 å°æ™‚é‡ç½®</div>
        <div class="hint-text">
          ç„¡è«–æŠ“æˆåŠŸ/å¤±æ•—ï¼Œçš†ä»¥ã€Œåˆ·æ–°å¾Œ +72 å°æ™‚ã€é‡ç½®ï¼›é‡ç½®å¾Œçš„é­”éˆå¯èƒ½æœƒåœ¨å…¶ä»–é»ä½å‡ºç¾ã€‚
        </div>
      </div>

      <div class="hint-block">
        <div class="hint-subtitle">é­”éˆå‡ºç¾è¦å‰‡ï¼ˆå°ç…§ï¼‰</div>
        <div class="hint-text">
          <ul class="hint-list">
            <li>ç¬¬ 1 å¤©ï¼šæˆåŠŸ â†’ ç¬¬ 2/3 å¤©ä¸é¡¯ç¤ºï¼›å¤±æ•— â†’ ç¬¬ 2/3 å¤©æŒçºŒé¡¯ç¤º</li>
            <li>ç¬¬ 2 å¤©ï¼šæˆåŠŸ â†’ ç¬¬ 3 å¤©ä¸é¡¯ç¤ºï¼›å¤±æ•— â†’ ç¬¬ 3 å¤©é¡¯ç¤º</li>
            <li>ç¬¬ 3 å¤©ï¼šæˆåŠŸ/å¤±æ•— â†’ ã€Œéé»ã€ç­‰åˆ·æ–°</li>
          </ul>
        </div>
      </div>
    </details>
  </div>
</header>

<main>
  <div id="mapWrap">
    <aside id="legend" aria-label="é»ä½ç‹€æ…‹èªªæ˜èˆ‡çµ±è¨ˆ"></aside>

    <div id="mapContainer">
      <img id="mapImg" alt="map" />
    </div>
  </div>

  <input id="fileMap" type="file" accept="image/*" style="display:none" />
  <input id="fileImport" type="file" accept="application/json,.json" style="display:none" />
</main>

<script>
/* =====================
   âœ… å®‰å…¨é™åˆ¶ï¼ˆä½ å¯èª¿æ•´ï¼‰
===================== */
const IMPORT_MAX_BYTES = 3 * 1024 * 1024;   // 3MBï¼šå°å…¥ JSON æª”ä¸Šé™
const IMPORT_MAX_MARKERS = 5000;            // marker ä¸Šé™ï¼ˆé¿å… DOM çˆ†ç‚¸ï¼‰
const ALLOW_EXPORT_BASE64_MAPS = false;     // ä½ é¸æ“‡ï¼šåŒ¯å‡ºä¸å« base64

/* =====================
   ç‹€æ…‹åœ–ç¤º & æ–‡å­—
===================== */
const stateIcons = ["icons/state0.png","icons/state1.png","icons/state2.png","icons/state3.png"];
const stateLegend = ["é‚„æ²’çœ‹","æŠ“åˆ°äº†","æ²’é­”éˆ","å¤±æ•— / éœ€å†è©¦"];
const STORAGE_KEY = "mapTaskTool_v4";

/* =====================
   é è¨­è³‡æ–™
===================== */
function createDefaultData() {
  return {
    maps: [
      { id: uid(), name: "åœ°åœ– 1", src: "maps/map1.png" },
      { id: uid(), name: "åœ°åœ– 2", src: "maps/map2.png" },
      { id: uid(), name: "åœ°åœ– 3", src: "maps/map3.png" },
      { id: uid(), name: "åœ°åœ– 4", src: "maps/map4.png" },
      { id: uid(), name: "åœ°åœ– 5", src: "maps/map5.png" },
      { id: uid(), name: "åœ°åœ– 6", src: "maps/map6.png" },
    ],
    markers: [],
    currentMapId: null
  };
}

let data = createDefaultData();
let mode = "normal";

/* =====================
   DOM
===================== */
const mapSelect = document.getElementById("mapSelect");
const mapNameInput = document.getElementById("mapName");
const mapImg = document.getElementById("mapImg");
const mapContainer = document.getElementById("mapContainer");
const modeLabel = document.getElementById("modeLabel");
const legendEl = document.getElementById("legend");

const btnAddMarker = document.getElementById("btnAddMarker");
const btnDeleteMarker = document.getElementById("btnDeleteMarker");
const btnResetAll = document.getElementById("btnResetAll");
const btnAddMap = document.getElementById("btnAddMap");
const btnDeleteMap = document.getElementById("btnDeleteMap");
const fileMap = document.getElementById("fileMap");

const btnExport = document.getElementById("btnExport");
const btnImport = document.getElementById("btnImport");
const fileImport = document.getElementById("fileImport");
const btnClearAll = document.getElementById("btnClearAll");

/* =====================
   åˆå§‹åŒ–
===================== */
load();
if (!data.currentMapId && data.maps.length) data.currentMapId = data.maps[0].id;
renderMapSelect();
syncCurrentMapUI();
render();

/* =====================
   äº‹ä»¶ï¼šåœ°åœ–åˆ‡æ› / æ”¹å
===================== */
mapSelect.addEventListener("change", () => {
  data.currentMapId = mapSelect.value;
  setMode("normal");
  syncCurrentMapUI();
  save();
  render();
});

mapNameInput.addEventListener("input", () => {
  const m = getCurrentMap();
  if (!m) return;
  m.name = mapNameInput.value.trim() || "æœªå‘½ååœ°åœ–";
  renderMapSelect(true);
  save();
  render();
});

/* =====================
   æ¨¡å¼æŒ‰éˆ•ï¼ˆæ–°å¢/åˆªé™¤é»ä½ï¼‰
===================== */
btnAddMarker.addEventListener("click", () => setMode(mode === "addMarker" ? "normal" : "addMarker"));
btnDeleteMarker.addEventListener("click", () => setMode(mode === "deleteMarker" ? "normal" : "deleteMarker"));

/* =====================
   ä¸€éµé‡ç½®
===================== */
btnResetAll.addEventListener("click", () => {
  if (!confirm("ç¢ºå®šè¦æŠŠã€æ‰€æœ‰åœ°åœ–ã€‘çš„ã€æ‰€æœ‰é»ä½ã€‘éƒ½é‡ç½®æˆç‹€æ…‹ 0ï¼Ÿ")) return;
  data.markers.forEach(m => m.state = 0);
  save();
  render();
});

/* =====================
   æ–°å¢åœ°åœ–ï¼ˆä¸Šå‚³æœƒè½‰ base64ï¼Œé€™æ˜¯ä½ ç¾åœ¨çš„è¨­è¨ˆï¼‰
===================== */
btnAddMap.addEventListener("click", () => {
  const name = prompt("è«‹è¼¸å…¥æ–°åœ°åœ–åç¨±ï¼š", `åœ°åœ– ${data.maps.length + 1}`);
  if (name === null) return;

  fileMap.value = "";
  fileMap.click();

  fileMap.onchange = async () => {
    const file = fileMap.files?.[0];
    if (!file) return;

    const src = await fileToDataURL(file);
    const newMap = { id: uid(), name: (name.trim() || "æœªå‘½ååœ°åœ–"), src };

    data.maps.push(newMap);
    data.currentMapId = newMap.id;

    setMode("normal");
    renderMapSelect();
    syncCurrentMapUI();
    save();
    render();
  };
});

/* =====================
   åˆªé™¤åœ°åœ–ï¼ˆå«è©²åœ–æ‰€æœ‰é»ä½ï¼‰
===================== */
btnDeleteMap.addEventListener("click", () => {
  const m = getCurrentMap();
  if (!m) return;

  const ok = confirm(`ç¢ºå®šè¦åˆªé™¤åœ°åœ–ã€Œ${m.name}ã€ï¼Ÿ\nï¼ˆè©²åœ°åœ–çš„æ‰€æœ‰é»ä½ä¹Ÿæœƒä¸€ä½µåˆªé™¤ï¼‰`);
  if (!ok) return;

  data.maps = data.maps.filter(x => x.id !== m.id);
  data.markers = data.markers.filter(mm => mm.mapId !== m.id);
  data.currentMapId = data.maps[0]?.id ?? null;

  setMode("normal");
  renderMapSelect();
  syncCurrentMapUI();
  save();
  render();
});

/* =====================
   åœ°åœ–é»æ“Šï¼šæ–°å¢é»ä½ï¼ˆæŒçºŒæ¨¡å¼ï¼‰
===================== */
mapContainer.addEventListener("click", (e) => {
  const m = getCurrentMap();
  if (!m) return;
  if (mode !== "addMarker") return;

  const rect = mapContainer.getBoundingClientRect();
  const x = (e.clientX - rect.left) / rect.width;
  const y = (e.clientY - rect.top) / rect.height;

  data.markers.push({ id: uid(), mapId: m.id, x: clamp01(x), y: clamp01(y), state: 0 });
  save();
  render();
});

/* =====================
   âœ… åŒ¯å‡ºï¼ˆè¼•é‡ï¼‰ï¼šä¸å« base64 åœ°åœ–
===================== */
btnExport.addEventListener("click", () => {
  const lite = buildExportLiteData();

  const payload = { exportedAt: new Date().toISOString(), version: 1, data: lite };
  const json = JSON.stringify(payload, null, 2);

  const blob = new Blob([json], { type: "application/json" });
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `map-task-data-lite-${formatDateForFile(new Date())}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(() => URL.revokeObjectURL(a.href), 1000);
});

/* =====================
   âœ… å°å…¥ï¼šæª”æ¡ˆå¤§å°/marker æ•¸é‡é™åˆ¶ + é©—è­‰
===================== */
btnImport.addEventListener("click", () => {
  fileImport.value = "";
  fileImport.click();
});

fileImport.addEventListener("change", async () => {
  const file = fileImport.files?.[0];
  if (!file) return;

  // æª”æ¡ˆå¤§å°é™åˆ¶ï¼ˆæœ€å¿«é˜»æ“‹ï¼‰
  if (file.size > IMPORT_MAX_BYTES) {
    alert(`âŒ å°å…¥å¤±æ•—ï¼šæª”æ¡ˆå¤ªå¤§ï¼ˆ${formatBytes(file.size)}ï¼‰ã€‚\nä¸Šé™ç‚º ${formatBytes(IMPORT_MAX_BYTES)}ã€‚`);
    return;
  }

  try {
    const text = await file.text();
    const parsed = JSON.parse(text);
    const incoming = parsed?.data ? parsed.data : parsed;

    // marker ä¸Šé™ï¼ˆé¿å… DOM çˆ†ç‚¸ï¼‰
    const incomingMarkers = Array.isArray(incoming?.markers) ? incoming.markers.length : 0;
    if (incomingMarkers > IMPORT_MAX_MARKERS) {
      alert(`âŒ å°å…¥å¤±æ•—ï¼šé»ä½æ•¸é‡éå¤šï¼ˆ${incomingMarkers}ï¼‰ã€‚\nä¸Šé™ç‚º ${IMPORT_MAX_MARKERS}ã€‚`);
      return;
    }

    assertValidData(incoming);

    const ok = confirm(
      "å°å…¥æœƒã€è¦†è“‹ã€‘ä½ ç›®å‰çš„æ‰€æœ‰åœ°åœ–/é»ä½/ç‹€æ…‹ã€‚\n" +
      "å»ºè­°å…ˆåŒ¯å‡ºå‚™ä»½å†å°å…¥ã€‚\n\nç¢ºå®šè¦å°å…¥å—ï¼Ÿ"
    );
    if (!ok) return;

    data = incoming;

    // ä¿®æ­£ currentMapIdï¼ˆé¿å…å°å…¥å¾ŒæŒ‡åˆ°ä¸å­˜åœ¨ï¼‰
    if (!data.currentMapId || !data.maps.some(m => m.id === data.currentMapId)) {
      data.currentMapId = data.maps[0]?.id ?? null;
    }

    setMode("normal");
    renderMapSelect();
    syncCurrentMapUI();
    save();
    render();

    // å¦‚æœåŒ¯å‡ºæ™‚å»æ‰ base64ï¼Œå¯èƒ½å­˜åœ¨éœ€è¦è£œåœ–çš„åœ°åœ–
    const needMaps = data.maps.filter(m => m.needsMapUpload === true);
    if (needMaps.length > 0) {
      alert("âœ… å°å…¥å®Œæˆï¼\nâš ï¸ æœ‰éƒ¨åˆ†åœ°åœ–éœ€è¦é‡æ–°ä¸Šå‚³åœ–ç‰‡ï¼ˆåŒ¯å‡ºç‚ºè¼•é‡æ¨¡å¼ä¸åŒ…å«è‡ªè¨‚åœ°åœ–ï¼‰ã€‚");
    } else {
      alert("âœ… å°å…¥å®Œæˆï¼");
    }
  } catch (err) {
    console.error(err);
    alert("âŒ å°å…¥å¤±æ•—ï¼šJSON æ ¼å¼ä¸æ­£ç¢ºæˆ–è³‡æ–™å…§å®¹ä¸ç¬¦åˆå·¥å…·æ ¼å¼ã€‚");
  }
});

/* =====================
   âœ… æ¸…ç©ºæ‰€æœ‰è³‡æ–™
===================== */
btnClearAll.addEventListener("click", () => {
  const ok = confirm(
    "âš ï¸ æ¸…ç©ºæ‰€æœ‰è³‡æ–™æœƒï¼š\n" +
    "1) åˆªé™¤æœ¬å·¥å…·çš„ localStorage è¨˜éŒ„\n" +
    "2) æ¸…ç©ºæ‰€æœ‰é»ä½ã€é‚„åŸé è¨­åœ°åœ–æ¸…å–®\n\n" +
    "å»ºè­°å…ˆåŒ¯å‡ºå‚™ä»½ã€‚\n\nç¢ºå®šè¦æ¸…ç©ºå—ï¼Ÿ"
  );
  if (!ok) return;

  localStorage.removeItem(STORAGE_KEY);

  data = createDefaultData();
  data.currentMapId = data.maps[0]?.id ?? null;

  setMode("normal");
  renderMapSelect();
  syncCurrentMapUI();
  render();

  alert("âœ… å·²æ¸…ç©ºå®Œæˆï¼ˆå›åˆ°åˆå§‹ç‹€æ…‹ï¼‰");
});

/* =====================
   Render
===================== */
function render() {
  renderLegendAndStats();

  const m = getCurrentMap();
  mapImg.src = m?.src || "";

  document.querySelectorAll(".marker").forEach(el => el.remove());
  if (!m) return;

  data.markers.filter(mm => mm.mapId === m.id).forEach(mm => {
    const el = document.createElement("img");
    el.className = "marker";
    el.src = stateIcons[mm.state] || stateIcons[0];
    el.style.left = (mm.x * 100) + "%";
    el.style.top  = (mm.y * 100) + "%";

    el.title = (mode === "deleteMarker") ? "é»ä¸€ä¸‹åˆªé™¤é€™å€‹é»ä½" : "é»ä¸€ä¸‹åˆ‡æ›ç‹€æ…‹ï¼ˆå…± 4 ç¨®ï¼‰";

    el.addEventListener("click", (ev) => {
      ev.stopPropagation();

      if (mode === "deleteMarker") {
        const ok = confirm("åˆªé™¤é€™å€‹é»ä½ï¼Ÿ");
        if (!ok) return;
        data.markers = data.markers.filter(x => x.id !== mm.id);
        save();
        render();
        return;
      }

      mm.state = (mm.state + 1) % stateIcons.length;
      el.src = stateIcons[mm.state];
      save();
      renderLegendAndStats();
    });

    mapContainer.appendChild(el);
  });

  modeLabel.textContent =
    mode === "normal" ? "ä¸€èˆ¬" :
    mode === "addMarker" ? "æ–°å¢é»ä½" : "åˆªé™¤é»ä½";
}

function renderLegendAndStats() {
  if (!legendEl) return;

  const legendItems = stateIcons.map((src, i) => {
    const text = stateLegend[i] ?? `ç‹€æ…‹ ${i}`;
    return `
      <div class="legend-item">
        <img class="legend-icon" src="${src}" alt="ç‹€æ…‹${i}">
        <div class="legend-text">${escapeHtml(text)}</div>
        <div class="legend-state">#${i}</div>
      </div>
    `;
  }).join("");

  const countsByMap = computeCountsByMap();

  const statsRows = data.maps.map(mp => {
    const c = countsByMap.get(mp.id) || { s1: 0, s3: 0 };
    return `
      <div class="stats-row">
        <div class="stats-name">${escapeHtml(mp.name || "æœªå‘½ååœ°åœ–")}</div>
        <div class="stats-counts">
          <span class="pill" title="state1 æ•¸é‡">
            <img src="${stateIcons[1]}" alt="s1"> ${c.s1}
          </span>
          <span class="pill" title="state3 æ•¸é‡">
            <img src="${stateIcons[3]}" alt="s3"> ${c.s3}
          </span>
        </div>
      </div>
    `;
  }).join("");

  const failedMaps = data.maps
    .filter(mp => (countsByMap.get(mp.id)?.s3 ?? 0) > 0)
    .map(mp => `<div class="fail-item">ä¸Šæ¬¡ã€Œ${escapeHtml(mp.name || "æœªå‘½ååœ°åœ–")}ã€æœ‰é­”éˆæ•æ‰å¤±æ•—</div>`)
    .join("");

  const failBlock = failedMaps
    ? `<div class="fail-title">æé†’</div>${failedMaps}`
    : `<div class="fail-title">æé†’</div><div class="fail-empty">ç›®å‰æ²’æœ‰æ•æ‰å¤±æ•—çš„åœ°åœ–ï¼ˆstate3 = 0ï¼‰ã€‚</div>`;

  legendEl.innerHTML = `
    <div class="legend-title">é»ä½ç‹€æ…‹</div>
    ${legendItems}

    <div class="panel-sep"></div>

    <div class="stats-title">åœ°åœ–çµ±è¨ˆ</div>
    ${statsRows}

    <div class="panel-sep"></div>
    ${failBlock}
  `;
}

function computeCountsByMap() {
  const state1Index = 1;
  const state3Index = 3;

  const map = new Map();
  for (const mp of data.maps) map.set(mp.id, { s1: 0, s3: 0 });

  for (const mk of data.markers) {
    const row = map.get(mk.mapId);
    if (!row) continue;
    if (mk.state === state1Index) row.s1 += 1;
    if (mk.state === state3Index) row.s3 += 1;
  }
  return map;
}

function renderMapSelect(preserveSelection = false) {
  const current = data.currentMapId;
  mapSelect.innerHTML = "";

  data.maps.forEach((m, i) => {
    const opt = document.createElement("option");
    opt.value = m.id;
    opt.textContent = m.name || `åœ°åœ– ${i + 1}`;
    mapSelect.appendChild(opt);
  });

  if (preserveSelection && current) mapSelect.value = current;
  if (!preserveSelection && data.currentMapId) mapSelect.value = data.currentMapId;
}

function syncCurrentMapUI() {
  const m = getCurrentMap();
  mapNameInput.value = m?.name || "";
  if (m?.id) mapSelect.value = m.id;
}

function setMode(next) {
  mode = next;
  btnAddMarker.classList.toggle("active", mode === "addMarker");
  btnDeleteMarker.classList.toggle("active", mode === "deleteMarker");
  render();
}

/* =====================
   localStorage
===================== */
function save() {
  try {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
  } catch (e) {
    alert("ä¿å­˜å¤±æ•—ï¼šlocalStorage ç©ºé–“å¯èƒ½ä¸å¤ ï¼ˆåœ°åœ–åœ–ç‰‡å¤ªå¤§ï¼‰ã€‚\nå»ºè­°ç¸®å°åœ–ç‰‡æˆ–æ¸›å°‘ä¸Šå‚³åœ°åœ–ã€‚");
  }
}

function load() {
  const raw = localStorage.getItem(STORAGE_KEY);
  if (!raw) return;
  try {
    const parsed = JSON.parse(raw);
    if (parsed?.maps && parsed?.markers) data = parsed;
  } catch {}
}

/* =====================
   âœ… åŒ¯å‡ºã€Œè¼•é‡ dataã€
   - ä¸è¼¸å‡º base64 src
   - è‡ªè¨‚ä¸Šå‚³åœ°åœ–ï¼ˆbase64ï¼‰æœƒè¢«æ¨™è¨˜ needsMapUpload
===================== */
function buildExportLiteData() {
  const lite = {
    maps: [],
    markers: data.markers.map(mk => ({ ...mk })), // marker æœ¬èº«ä¸å¤§
    currentMapId: data.currentMapId
  };

  for (const mp of data.maps) {
    const isBase64 = typeof mp.src === "string" && mp.src.startsWith("data:image/");
    if (!ALLOW_EXPORT_BASE64_MAPS && isBase64) {
      // ä¸åŒ¯å‡º base64ï¼šä¿ç•™åœ°åœ–æ¢ç›®ä½†æ¸…ç©º srcï¼Œä¸¦æ¨™è¨˜è¦è£œåœ–
      lite.maps.push({
        id: mp.id,
        name: mp.name,
        src: "",
        needsMapUpload: true
      });
    } else {
      lite.maps.push({
        id: mp.id,
        name: mp.name,
        src: mp.src,
        needsMapUpload: !!mp.needsMapUpload
      });
    }
  }

  // è‹¥ currentMapId æŒ‡å‘ needsMapUpload çš„ç©º srcï¼Œä¹Ÿæ²’é—œä¿‚ï¼›ä½¿ç”¨è€…è‡ªå·±è£œåœ–å³å¯
  return lite;
}

/* =====================
   âœ… å°å…¥é©—è­‰/ä¿®æ­£
===================== */
function assertValidData(d) {
  if (!d || typeof d !== "object") throw new Error("data not object");
  if (!Array.isArray(d.maps) || !Array.isArray(d.markers)) throw new Error("missing maps/markers");

  for (const m of d.maps) {
    if (!m || typeof m !== "object") throw new Error("bad map");
    if (typeof m.id !== "string") throw new Error("map.id missing");
    if (typeof m.name !== "string") m.name = "æœªå‘½ååœ°åœ–";
    if (typeof m.src !== "string") m.src = "";
    if (typeof m.needsMapUpload !== "boolean") m.needsMapUpload = (m.src === "");
  }

  for (const mk of d.markers) {
    if (!mk || typeof mk !== "object") throw new Error("bad marker");
    if (typeof mk.id !== "string") throw new Error("marker.id missing");
    if (typeof mk.mapId !== "string") throw new Error("marker.mapId missing");
    if (typeof mk.x !== "number" || typeof mk.y !== "number") throw new Error("marker.x/y missing");
    if (typeof mk.state !== "number") mk.state = 0;

    mk.state = ((mk.state % stateIcons.length) + stateIcons.length) % stateIcons.length;
    mk.x = clamp01(mk.x);
    mk.y = clamp01(mk.y);
  }

  if (d.currentMapId !== null && typeof d.currentMapId !== "string") d.currentMapId = null;

  const mapIds = new Set(d.maps.map(m => m.id));
  d.markers = d.markers.filter(mk => mapIds.has(mk.mapId));
}

/* =====================
   å·¥å…·å‡½å¼
===================== */
function getCurrentMap() {
  return data.maps.find(m => m.id === data.currentMapId) || null;
}

function uid() {
  return (crypto?.randomUUID?.() || ("id_" + Math.random().toString(16).slice(2) + Date.now()));
}

function clamp01(n) {
  return Math.min(1, Math.max(0, n));
}

function fileToDataURL(file) {
  return new Promise((resolve, reject) => {
    const r = new FileReader();
    r.onload = () => resolve(r.result);
    r.onerror = reject;
    r.readAsDataURL(file);
  });
}

function escapeHtml(s) {
  return String(s)
    .replaceAll("&","&amp;")
    .replaceAll("<","&lt;")
    .replaceAll(">","&gt;")
    .replaceAll('"',"&quot;")
    .replaceAll("'","&#039;");
}

function formatDateForFile(dt) {
  const y = dt.getFullYear();
  const m = String(dt.getMonth() + 1).padStart(2, "0");
  const d = String(dt.getDate()).padStart(2, "0");
  const hh = String(dt.getHours()).padStart(2, "0");
  const mm = String(dt.getMinutes()).padStart(2, "0");
  return `${y}${m}${d}-${hh}${mm}`;
}

function formatBytes(bytes) {
  const units = ["B", "KB", "MB", "GB"];
  let n = bytes;
  let i = 0;
  while (n >= 1024 && i < units.length - 1) { n /= 1024; i++; }
  return `${n.toFixed(i === 0 ? 0 : 2)} ${units[i]}`;
}
</script>
</body>
</html>

